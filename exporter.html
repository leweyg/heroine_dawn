<html>
    <head><title>Exporter</title></head>
    <body>
        <h1>Exporter</h1>
        <p>Loading...</p>
        <script>
            function createImageOrObject() {
                // if exporting:
                return { };
                // normally:
                return new Image();
            }
        </script>
        <script src="web/scripts/utils.js"></script>
        <script src="original/js/power.js"></script>
        <script src="original/js/enemy.js"></script>
        <script src="original/js/atlas.js"></script>
        <script src="original/js/shop.js"></script>
        <script src="original/js/tileset.js"></script>
        <script src="original/js/info.js"></script>
        <script src="original/js/mapscript.js"></script>
        <script src="original/js/bitfont.js"></script>
        <p>Exporting... (should go to 'web/world.json')</p>
        <textarea id="main_export" cols="80" rows="24"></textarea>
        <script>
            function clean_obj(src) {
                var res = {};
                for (var i in src) {
                    if ((i == "exit_x") || (i == "exit_y")) continue;
                    res[i] = src[i];
                }
                return res;
            }
            function clean_shop(shop) {
                var item_type_to_name = {
                    0 : "weapon",
                    1 : "armor",
                    2 : "spell",
                    3 : "room",
                    4 : "message",
                };
                var items = [];
                for (var i in shop.item) {
                    var from = shop.item[i];
                    if (!from) continue;
                    from.type = item_type_to_name[from.type];
                    if ((from.type=="weapon")||(from.type=="armor")||(from.type=="spell")) {
                      if (from.value==undefined) {
                        from.type = "message";
                      } else {
                        from.ref = "world.equipment." + from.type + "s[" + from.value + "]";
                      }
                    }
                    items.push(from);
                }
                shop.item = items;
                return shop;
            }
            var mapscript_place_current_map = null;
            var mapscript_world = null;
            function mapscript_place_generic(x,y,item) {
                var tile = mapscript_place_current_map.tiles[y][x];
                tile.thing = item;
            }
            function mapscript_place_sleep(x,y) {
                mapscript_place_generic(x,y, {
                    type: "sleep", name:"Haybale"
                });
            }
            function mapscript_place_chest(x,y,stat,name,count) {
                var item = {
                    type:"chest", stat:stat, name:name, count:count
                };
                mapscript_place_generic(x,y,item);
                var treasures = mapscript_world.equipment.treasures;
                var found = false;
                for (var ti in treasures) {
                  var tr = treasures[ti];
                  if (tr.name == name) {
                    //tr.stat = stat;
                    delete item.name;
                    delete item.stat;
                    item.treasure_id = tr.index;
                    item.type = "chest";
                    item.ref = "world.equipment.treasures[" + tr.index + "]";
                    found = true;
                  }
                }
                if (!found) {
                  alert("Didn't find " + name);
                }
            }
            function mapscript_place_enemy(x, y, enemy_id, extra) {
                mapscript_place_generic(x,y, {
                    type: "enemy", enemy_id:enemy_id, extra:extra,
                    ref: "world.enemies[" + enemy_id + "]",
                });
            }
            function add_array_indices(ar) {
              for (var i in ar) {
                ar[i].index = 1*i;
              }
              return ar;
            }
            function export_world_atlas() {
                var world = {
                    intro_note: [
                    "Heroine,",
                    "We have tamed a few entities",
                    "in the northern monastery,",
                    "but not those outside.",
                    "Seek the Sage in west village",
                    "to open the south tunnels",
                    "and get the 'key' to the east",
                    "Speaker who tames all."
                    ],
                    summary : [],
                    backgrounds : [],
                    tile_types : [ { index:0, walkable: false, name:"Empty", } ],
                    avatar : avatar_default(),
                    equipment : {},
                    people : [],
                    enemies : [],
                    maps : [],
                    font : {},
                    rendering : {},
                };
                // export backgrounds and tile types:
                tileset_init();
                for (var bi in tileset.background_img) {
                    var from = tileset.background_img[bi];
                    var to = {
                        index : bi*1,
                        name : dawnUtils.cleanPathToName(from.src),
                        src : from.src
                    };
                    world.backgrounds.push(to);
                }
                var topdown_paths = [
                  "",
                  "tile_0022.png", // floor
                  "tile_0095.png", // wall
                  "tile_0109.png", // door
                  "tile_0058.png", // pillar
                  "tile_0022.png", // cieling 5
                  "tile_0019.png", // grass
                  "tile_0058.png", // pillar
                  "tile_0134.png", // chest
                  "tile_0134.png", // chest 9 interior
                  "tile_0114.png", // house 10
                  "tile_0117.png", // house door
                  "tile_0016.png", // tree 12
                  "tile_0065.png", // cross
                  "tile_0066.png", // grave
                  "tile_0090.png", // water 15
                  "tile_0118.png", // skull pile
                  "tile_0122.png", // hay pile
                  "tile_0110.png", // locked door
                  "tile_0120.png", // death speaker
                ];
                for (var ti in tileset.tile_img) {
                    var from = tileset.tile_img[ti];
                    var to = {
                        name: dawnUtils.cleanPathToName(from.src),
                        index: ti*1,
                        src : from.src,
                        topdown_src : "images/topdown/" + topdown_paths[ti],
                        walkable : tileset.walkable[ti],
                    };
                    world.tile_types.push(to);
                }
                // export equipment:
                info_init();
                mapscript_world = world;
                var treasureNames = [
                  "Gold", "Gold (2)", "Gold (4)", "Gold (8)", "Gold (16)",
                  "Chalice", "Bars of Gold", "Gold Chest", "Crown", "Riches",
                  "Wood Stick", "Spellbook: Heal", "Magic Sapphire (MP Up)", 
                  "Magic Emerald (HP Up)", "Magic Ruby (Atk Up)",
                  "Magic Diamond (Def Up)"
                ];
                world.equipment.treasures = [];
                for (var ti in treasureNames) {
                  var treasure = {
                    index: 1*ti,
                    name: treasureNames[ti],
                  };
                  if (treasure.name == "Gold") {
                    treasure.gold = 1;
                    treasure.stat = "gold";
                  }
                  if (treasure.name.startsWith("Gold (")) {
                    var count = 1*(treasure.name.substring("Gold (".length).replace(")",""));
                    treasure.add = count;
                    treasure.stat = "gold";
                  }
                  if (treasure.name == "Wood Stick") {
                    treasure.stat = "weapon";
                    treasure.min_value = 1;
                  }
                  if (treasure.name == "Spellbook: Heal") {
                    treasure.stat = "spellbook";
                    treasure.min_value = 1;
                  }
                  if (treasure.name == "Magic Sapphire (MP Up)") {
                    treasure.stat = "mp";
                    treasure.add = 2;
                  }
                  if (treasure.name == "Magic Emerald (HP Up)") {
                    treasure.stat = "hp";
                    treasure.add = 5;
                  }
                  if (treasure.name == "Magic Ruby (Atk Up)") {
                    treasure.stat = "bonus_atk";
                    treasure.add = 1;
                  }
                  if (treasure.name == "Magic Diamond (Def Up)") {
                    treasure.stat = "bonus_def";
                    treasure.add = 1;
                  }
                  world.equipment.treasures.push(treasure);
                }
                
                world.equipment.weapons = add_array_indices(info.weapons);
                world.equipment.armors = add_array_indices(info.armors);
                world.equipment.spells = add_array_indices(info.spells);
                // export npcs:
                enemy_init();
                var powers_by_id = [ "attack", "fire", "hpdrain", "mpdrain" ];
                var categories_by_id = [ "shadow", "demon", "undead", "automaton" ];
                var anims_by_id = [
                  ["center","left","right"], // tendrils
                  ["center","up","down"], // imp
                  ["center","right","up_left"], // shadow soul
                  ["center","left","down_right"], // zombie
                  ["right","up_right","down_left"], // skeleton
                  ["left","up_left","up_right"], // druid
                  ["center","down","up"], // mimic,
                  ["down_left","up","down_right"], // death speaker
                ];
                for (var ei in enemy.stats) {
                    var from = enemy.stats[ei];
                    from.index = ei*1;
                    from.src = enemy.img[ei].src;
                    from.category = categories_by_id[from.category];
                    for (var pi in from.powers) {
                        from.powers[pi] = powers_by_id[from.powers[pi]];
                    }
                    from.anim = anims_by_id[ei];
                    world.enemies.push( from );
                }
                // export maps:
                for (var mi in atlas.maps) {
                    var from = atlas.maps[mi];
                    var to = { 
                        index: mi*1,
                        name: from.name,
                        music: from.music,
                        enemies: from.enemies,
                        width: from.width,
                        height: from.height,
                        background: from.background,
                        tiles: [],
                    };
                    world.maps.push(to);
                    // export tile types:
                    for (var yi=0; yi<from.height; yi++) {
                        var row = [];
                        to.tiles.push(row);
                        for (var xi=0; xi<from.width; xi++) {
                            var type = from.tiles[yi][xi];
                            var tile = { t:type };
                            row.push(tile);
                        }
                    }
                    // export exits:
                    for (var ei in from.exits) {
                        var ex = from.exits[ei];
                        var tile = to.tiles[ex.exit_y][ex.exit_x];
                        var exit = clean_obj(ex);
                        exit.type = 'exit';
                        exit.ref = "world.maps[" + exit.dest_map + "]";
                        tile.thing = exit;
                    }
                    // export shops:
                    for (var ei in from.shops) {
                        var ex = from.shops[ei];
                        var tile = to.tiles[ex.exit_y][ex.exit_x];
                        var person = clean_shop( shop[ex.shop_id] );
                        person.index = world.people.length;
                        world.people.push(person);
                        tile.thing = {
                          type:"person", 
                          person_id:person.index,
                          ref:"world.people[" + person.index + "]",
                         };
                    }
                    // export items:
                    mapscript_export(1*mi, to);
                }
                // export things to map:
                for (var ii in mapscript.bone_piles) {
                    var item = mapscript.bone_piles[ii];
                    var tile = world.maps[item.map_id].tiles[item.y][item.x];
                    tile.thing = { type:"bones", status: item.status };
                }
                for (var ii in mapscript.locked_doors) {
                    var item = mapscript.locked_doors[ii];
                    var tile = world.maps[item.map_id].tiles[item.y][item.x];
                    tile.thing = { type:"locked_door", status: item.status };
                }
                // collect things:
                for (var mi in world.maps) {
                    var map = world.maps[mi];
                    map.things = [];
                    var rows = [];
                    for (var y in map.tiles) {
                        var row = []; rows.push(row);
                        for (var x in map.tiles[y]) {
                            var tile = map.tiles[y][x];
                            if (tile.thing) {
                                tile.thing.x = 1*x;
                                tile.thing.y = 1*y;
                                map.things.push(tile.thing);
                            }
                            row.push(tile.t);
                        }
                    }
                    map.tiles = rows;
                }
                world.maps[1].tamed = true;
                // export font data:
                world.font = {
                  src: "images/interface/boxy_bold.png",
                  height : bitfont.height,
                  kerning : -1,
                  space : 3,
                  glyph : "",
                  start : [],
                  width : [],
                };
                var glyphOrder = [];
                for (var letter in bitfont.glyph_x) {
                  glyphOrder.push( { 
                    letter:""+letter,
                    start:bitfont.glyph_x[letter] 
                  });
                }
                glyphOrder.sort((a,b) => (a.start - b.start));
                for (var i in glyphOrder) {
                  var kv = glyphOrder[i];
                  var letter = kv.letter;
                  world.font.glyph += letter;
                  world.font.width.push( bitfont.glyph_w[letter]);
                  world.font.start.push( bitfont.glyph_x[letter]);
                }
                console.assert(world.font.glyph.length == world.font.width.length);
                // export rendering data:
                world.rendering = renderer;
                var sheetNames = {};
                for (var i in world.rendering.sheets) {
                  var sheet = world.rendering.sheets[i];
                  sheet.index = 1*i;
                  sheetNames[world.rendering.sheets[i].name] = i;
                }
                world.rendering.sheets_by_name = sheetNames;
                // clean equipment:
                for (var cat in world.equipment) {
                  var typeName = cat.substring(0,cat.length-1);
                  var group = world.equipment[cat];
                  for (var j in group) {
                    var item = group[j];
                    item.type = typeName;
                    var sheetId = world.rendering.sheets_by_name[item.type];
                    item.ref_sheet = "world.rendering.sheets[" + sheetId + "]";
                  }
                }
                // build summary:
                for (var wi in world) {
                    world.summary.push(wi);
                }
                // export world to JSON:
                main_export.value = dawnUtils.customJsonStringify(world);
            }
        </script>
        <script>
            function avatar_default() {
                var avatar = {};
  avatar.x = 1;
  avatar.y = 1;
  avatar.facing = "south";
  avatar.moved = false;
  avatar.map_id = 0;
  avatar.weapon = 0;
  avatar.armor = 1;
  avatar.hp = 25;
  avatar.max_hp = 25;
  avatar.mp = 4;
  avatar.max_mp = 4;
  avatar.gold = 0;
  avatar.bonus_atk = 0;
  avatar.bonus_def = 0;
  avatar.spellbook = 0;
  avatar.sleeploc = [0,1,1]; // map_id, x, y
  avatar.type = "avatar";
  avatar.type_map_id = "world.maps";
  avatar.type_weapon = "world.equipment.weapons";
  avatar.type_armor = "world.equipment.armors";
  avatar.type_spellbook = "world.equipment.spells";
  return avatar;
}
        </script>
        <script>
  var spritesheets = [
    {
      "name":"avatar",
      src : "images/interface/heroine.png",
      start_x : 0,
      start_y : 0,
      width : 80,
      height : 100,
      count : 1,
      draw_x : 40,
      draw_y : 20,
    },
    {
      "name":"armor",
      src : "images/interface/heroine.png",
      start_x : 0,
      start_y : 0,
      width : 80,
      height : 100,
      count : 8,
      draw_x : 40,
      draw_y : 20,
    },
    {
      "name":"weapon",
      src : "images/interface/heroine.png",
      start_x : 0,
      start_y : 100,
      width : 80,
      height : 100,
      count : 8,
      draw_x : 40,
      draw_y : 20,
    },
    {
      "name":"treasure",
      src : "images/treasure/treasure.png",
      start_x : 0,
      start_y : 0,
      width : 32,
      height : 32,
      count : 16,
      draw_x : 64,
      draw_y : 84,
    },
    {
      "name":"spell",
      src : "images/interface/action_buttons.png",
      start_x : 16,
      start_y : 0,
      width : 16,
      height : 16,
      count : 8,
      draw_x : 1,
      draw_y : 94,
    },
    {
      "name":"attack_icon",
      src : "images/interface/action_buttons.png",
      start_x : 0,
      start_y : 0,
      width : 16,
      height : 16,
      count : 1,
      draw_x : 143,
      draw_y : 94,
    },
    {
      "name":"info_icon",
      src : "images/interface/info_button.png",
      start_x : 0,
      start_y : 0,
      width : 16,
      height : 16,
      count : 2,
      draw_x : 143,
      draw_y : 1,
    },
  ];
  var renderer = {
    screen : {
      width: 160, height:120,
    },
    sheets : spritesheets,
    "directions_right" : [ "north", "east", "south", "west" ],
    screen_directions : {
      up:{x:0,y:-1},
      up_right:{x:1,y:-1},
      right:{x:1,y:0},
      down_right:{x:1,y:1},
      down:{x:0,y:1},
      down_left:{x:-1,y:1},
      left:{x:-1,y:0},
      up_left:{x:-1,y:-1},
      center:{x:0,y:0},
    },
    "visible_cells_north": [
      {
        "dx": -2,
        "dy": -2,
        "index": 0
      },
      {
        "dx": 2,
        "dy": -2,
        "index": 1
      },
      {
        "dx": -1,
        "dy": -2,
        "index": 2
      },
      {
        "dx": 1,
        "dy": -2,
        "index": 3
      },
      {
        "dx": 0,
        "dy": -2,
        "index": 4
      },
      {
        "dx": -2,
        "dy": -1,
        "index": 5
      },
      {
        "dx": 2,
        "dy": -1,
        "index": 6
      },
      {
        "dx": -1,
        "dy": -1,
        "index": 7
      },
      {
        "dx": 1,
        "dy": -1,
        "index": 8
      },
      {
        "dx": 0,
        "dy": -1,
        "index": 9
      },
      {
        "dx": -1,
        "dy": 0,
        "index": 10
      },
      {
        "dx": 1,
        "dy": 0,
        "index": 11
      },
      {
        "dx": 0,
        "dy": 0,
        "index": 12
      }
    ],
    "transform_by_direction": {
      "north": {
        "tx": "+x",
        "ty": "+y",
        "fx": 0,
        "fy": -1
      },
      "east": {
        "tx": "-y",
        "ty": "+x",
        "fx": 1,
        "fy": 0
      },
      "south": {
        "tx": "-x",
        "ty": "-y",
        "fx": 0,
        "fy": 1
      },
      "west": {
        "tx": "+y",
        "ty": "-x",
        "fx": -1,
        "fy": 0
      }
    },
    "tile_parts_by_visible_cell": [
      {
        "width": 80,
        "height": 120,
        "src_x": 0,
        "src_y": 0,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 80,
        "src_y": 0,
        "dest_x": 80,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 160,
        "src_y": 0,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 240,
        "src_y": 0,
        "dest_x": 80,
        "dest_y": 0
      },
      {
        "width": 160,
        "height": 120,
        "src_x": 320,
        "src_y": 0,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 480,
        "src_y": 0,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 560,
        "src_y": 0,
        "dest_x": 80,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 0,
        "src_y": 120,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 80,
        "src_y": 120,
        "dest_x": 80,
        "dest_y": 0
      },
      {
        "width": 160,
        "height": 120,
        "src_x": 160,
        "src_y": 120,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 320,
        "src_y": 120,
        "dest_x": 0,
        "dest_y": 0
      },
      {
        "width": 80,
        "height": 120,
        "src_x": 400,
        "src_y": 120,
        "dest_x": 80,
        "dest_y": 0
      },
      {
        "width": 160,
        "height": 120,
        "src_x": 480,
        "src_y": 120,
        "dest_x": 0,
        "dest_y": 0
      }
    ],

  }
        </script>
        <script>
            export_world_atlas();
        </script>
        <br/>
        <textarea id="main_random">

        </textarea>
        <script>
          function fill_random() {
            var count = 30;
            var ans = [];
            for (var i=0; i<count; i++) {
              ans.push( Math.random() );
            }
            main_random.value = JSON.stringify(ans,null,2);
          }
          fill_random();
        </script>
    </body>
</html>