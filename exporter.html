<html>
    <head><title>Exporter</title></head>
    <body>
        <h1>Exporter</h1>
        <p>Loading...</p>
        <script>
            function createImageOrObject() {
                // if exporting:
                return { };
                // normally:
                return new Image();
            }
        </script>
        <script src="original/js/power.js"></script>
        <script src="original/js/enemy.js"></script>
        <script src="original/js/atlas.js"></script>
        <script src="original/js/shop.js"></script>
        <script src="original/js/tileset.js"></script>
        <script src="original/js/info.js"></script>
        <script src="original/js/mapscript.js"></script>
        <p>Exporting... (should go to 'web/world.json')</p>
        <textarea id="main_export" cols="80" rows="24"></textarea>
        <script>
            function clean_obj(src) {
                var res = {};
                for (var i in src) {
                    if ((i == "exit_x") || (i == "exit_y")) continue;
                    res[i] = src[i];
                }
                return res;
            }
            function clean_shop(shop) {
                var item_type_to_name = {
                    0 : "weapon",
                    1 : "armor",
                    2 : "spell",
                    3 : "room",
                    4 : "message",
                };
                var items = [];
                for (var i in shop.item) {
                    var from = shop.item[i];
                    if (!from) continue;
                    from.type = item_type_to_name[from.type];
                    items.push(from);
                }
                shop.item = items;
                return shop;
            }
            var mapscript_place_current_map = null;
            function mapscript_place_generic(x,y,item) {
                var tile = mapscript_place_current_map.tiles[y][x];
                tile.thing = item;
            }
            function mapscript_place_sleep(x,y) {
                mapscript_place_generic(x,y, {
                    type: "sleep", name:"Haybale"
                });
            }
            function mapscript_place_chest(x,y,stat,name,count) {
                mapscript_place_generic(x,y, {
                    type:"chest", stat:stat, name:name, count:count
                });
            }
            function mapscript_place_enemy(x, y, enemy_id, extra) {
                mapscript_place_generic(x,y, {
                    type: "enemy", enemy_id:enemy_id, extra:extra
                });
            }
            function export_world_atlas() {
                var world = {
                    summary : [],
                    backgrounds : [],
                    tile_types : [ { index:0, walkable: false, } ],
                    equipment : {},
                    people : [],
                    enemies : [],
                    maps : [],
                };
                // export backgrounds and tile types:
                tileset_init();
                for (var bi in tileset.background_img) {
                    var from = tileset.background_img[bi];
                    var to = {
                        index : bi*1,
                        src : from.src
                    };
                    world.backgrounds.push(to);
                }
                for (var ti in tileset.tile_img) {
                    var from = tileset.tile_img[ti];
                    var to = {
                        index: ti*1,
                        src : from.src,
                        walkable : tileset.walkable[ti],
                    };
                    world.tile_types.push(to);
                }
                // export equipment:
                info_init();
                world.equipment.weapons = info.weapons;
                world.equipment.armors = info.armors;
                world.equipment.spells = info.spells;
                // export npcs:
                enemy_init();
                var powers_by_id = [ "attack", "fire", "hpdrain", "mpdrain" ];
                for (var ei in enemy.stats) {
                    var from = enemy.stats[ei];
                    from.index = ei*1;
                    from.image_src = enemy.img[ei].src;
                    for (var pi in from.powers) {
                        from.powers[pi] = powers_by_id[from.powers[pi]];
                    }
                    world.enemies.push( from );
                }
                // export maps:
                for (var mi in atlas.maps) {
                    var from = atlas.maps[mi];
                    var to = { 
                        index: mi*1,
                        name: from.name,
                        music: from.music,
                        enemies: from.enemies,
                        width: from.width,
                        height: from.height,
                        background: from.background,
                        tiles: [],
                    };
                    world.maps.push(to);
                    // export tile types:
                    for (var yi=0; yi<from.height; yi++) {
                        var row = [];
                        to.tiles.push(row);
                        for (var xi=0; xi<from.width; xi++) {
                            var type = from.tiles[yi][xi];
                            var tile = { t:type };
                            row.push(tile);
                        }
                    }
                    // export exits:
                    for (var ei in from.exits) {
                        var ex = from.exits[ei];
                        var tile = to.tiles[ex.exit_y][ex.exit_x];
                        tile.exit = clean_obj(ex);
                    }
                    // export shops:
                    for (var ei in from.shops) {
                        var ex = from.shops[ei];
                        var tile = to.tiles[ex.exit_y][ex.exit_x];
                        var person = clean_shop( shop[ex.shop_id] );
                        person.index = world.people.length;
                        world.people.push(person);
                        tile.person_id = person.index;
                    }
                    // export items:
                    mapscript_export(1*mi, to);
                }
                // export things to map:
                for (var ii in mapscript.bone_piles) {
                    var item = mapscript.bone_piles[ii];
                    var tile = world.maps[item.map_id].tiles[item.y][item.x];
                    tile.thing = { type:"bones", status: item.status };
                }
                for (var ii in mapscript.locked_doors) {
                    var item = mapscript.locked_doors[ii];
                    var tile = world.maps[item.map_id].tiles[item.y][item.x];
                    tile.thing = { type:"locked_door", status: item.status };
                }
                // build summary:
                for (var wi in world) {
                    world.summary.push(wi);
                }
                // export world to JSON:
                main_export.value = JSON.stringify(world,null,2);
            }

            export_world_atlas();
        </script>
    </body>
</html>